"""
Gemini AI ìš”ì•½ ëª¨ë“ˆ
- ë“€ì–¼ ì¶œë ¥: kakao_summary (ì¹´í†¡ìš© í—¤ë“œë¼ì¸) + web_report (ì›¹ì‚¬ì´íŠ¸ìš© ì‹¬ì¸µ ë¶„ì„)
- ë‘ ìš”ì•½ì€ main_topicsë¥¼ ê³µí†µ ë¼ˆëŒ€ë¡œ ê³µìœ í•˜ì—¬ ë‚´ìš©ì´ ì •í•©ë¨

Refactored: uses core.config for API key and model settings.
"""

import json
import re

from google import genai

from core.config import Config
from core.logger import get_logger

log = get_logger("news_briefing.summarizer")

# Lazy-initialized client
_client = None


def _get_client():
    global _client
    if _client is None:
        cfg = Config.instance()
        api_key = cfg.get_secret("GEMINI_API_KEY")
        _client = genai.Client(api_key=api_key)
    return _client


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë“€ì–¼ í”„ë¡¬í”„íŠ¸: ì¹´ì¹´ì˜¤í†¡ + ì›¹ ë¦¬í¬íŠ¸ ë™ì‹œ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DUAL_SUMMARY_PROMPT = """
ë‹¹ì‹ ì€ ëƒ‰ì² í•˜ê³  ë¶„ì„ì ì¸ 'ê²½ì œ ë‰´ìŠ¤ ì „ë¬¸ AI ì• ë„ë¦¬ìŠ¤íŠ¸'ì…ë‹ˆë‹¤.
ì œê³µëœ ìœ íŠœë¸Œ ê²½ì œ ì˜ìƒì˜ ìë§‰ì„ ë¶„ì„í•˜ì—¬, ì•„ë˜ JSON ìŠ¤í‚¤ë§ˆì— ë§ê²Œ ìš”ì•½ì„ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[í•µì‹¬ ì›ì¹™: ì¹´ì¹´ì˜¤í†¡ â†” ì›¹ ë¦¬í¬íŠ¸ ì—°ë™]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- `main_topics`ê°€ ê³µí†µ ë¼ˆëŒ€ì…ë‹ˆë‹¤.
- `kakao_summary`ëŠ” ê° main_topicì„ í•œ ì¤„ë¡œ ìš”ì•½í•©ë‹ˆë‹¤. (í—¤ë“œë¼ì¸ ì—­í• )
- `web_report`ëŠ” ê° main_topicì„ ìƒì„¸íˆ ë¶„ì„í•©ë‹ˆë‹¤. (ì‹¬ì¸µ ë¦¬í¬íŠ¸ ì—­í• )
- ë‘ ìš”ì•½ì€ ë°˜ë“œì‹œ ë™ì¼í•œ ì£¼ì œë¥¼ ë‹¤ë£¨ë˜, ê¹Šì´ë§Œ ë‹¤ë¦…ë‹ˆë‹¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ê³µí†µ ì§€ì¹¨]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. ê°ì •ì  í‘œí˜„ ë°°ì œ, ì‚¬ì‹¤Â·ìˆ˜ì¹˜ ìœ„ì£¼ë¡œ ëª…í™•í•˜ê²Œ ì‘ì„±
2. ì£¼ê°€, í™˜ìœ¨, ë“±ë½í­ ë“± êµ¬ì²´ì  ìˆ˜ì¹˜ëŠ” ë°˜ë“œì‹œ í¬í•¨
3. ì˜ìƒì— ì—†ëŠ” ë‚´ìš©ì€ ì ˆëŒ€ ì§€ì–´ë‚´ì§€ ë§ê³  null í‘œê¸°
4. ë°˜ë“œì‹œ ìœ íš¨í•œ JSONìœ¼ë¡œë§Œ ì‘ë‹µ (```json ì½”ë“œë¸”ë¡ ì•ˆì— ì‘ì„±)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì…ë ¥ ë°ì´í„°]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ì˜ìƒ ë§í¬: {video_url}
- ìë§‰ ë‚´ìš©: {transcript}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì¶œë ¥ JSON ìŠ¤í‚¤ë§ˆ]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{{
    "main_topics": ["ì£¼ì œ1", "ì£¼ì œ2", "ì£¼ì œ3 (ìµœëŒ€ 5ê°œ, í•µì‹¬ í† í”½)"],

    "key_insights": [
        "ì‹œì¥ì— ì˜í–¥ì„ ë¯¸ì¹œ í•µì‹¬ ì¸ê³¼ê´€ê³„ 1",
        "ì£¼ìš” ê²½ì œ ì •ì±… ë˜ëŠ” ê¸°ì—… ì´ìŠˆ 2",
        "í–¥í›„ ì „ë§ ë˜ëŠ” ë¦¬ìŠ¤í¬ ìš”ì¸ 3 (ìµœëŒ€ 5ê°œ)"
    ],

    "kakao_summary": "(ì•„ë˜ ê·œì¹™ ì°¸ê³ )",

    "web_report": "(ì•„ë˜ ê·œì¹™ ì°¸ê³ )"
}}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[kakao_summary ì‘ì„± ê·œì¹™] â€” ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ìš© (í—¤ë“œë¼ì¸)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- main_topicsì˜ ê° ì£¼ì œë¥¼ í•œ ì¤„ì”© ìš”ì•½í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì‘ì„±
- ê° ì¤„ì€ `â–¸ [ì£¼ì œëª…]: í•œì¤„ ìš”ì•½ (í•µì‹¬ ìˆ˜ì¹˜ í¬í•¨)` í˜•íƒœ
- ì „ì²´ 400ì ì´ë‚´
- ë§ˆì§€ë§‰ì— ğŸ’¡ í•œì¤„ ì¸ì‚¬ì´íŠ¸ ì¶”ê°€

ì˜ˆì‹œ í˜•ì‹:
"â–¸ ë¯¸êµ­ CPI ë‘”í™”: ì‹œì¥ ì˜ˆìƒ í•˜íšŒ, 6ì›” ê¸ˆë¦¬ì¸í•˜ ê¸°ëŒ€ ê°•í™”\\n"
"â–¸ ë°˜ë„ì²´ ìˆ˜ì¶œ í˜¸ì¡°: HBM ìˆ˜ìš” ì§€ì†, ì‚¼ì„±Â·í•˜ì´ë‹‰ìŠ¤ ê°•ì„¸\\n"
"â–¸ ì›í™” ê°•ì„¸: ë‹¬ëŸ¬ ì•½ì„¸ ì „í™˜, ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜ ì§€ì†\\n\\n"
"ğŸ’¡ ê¸ˆë¦¬ì¸í•˜ ê¸°ëŒ€ë¡œ ì„±ì¥ì£¼ ì¤‘ì‹¬ ë°˜ë“± ê°€ëŠ¥ì„±"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[web_report ì‘ì„± ê·œì¹™] â€” ì›¹í˜ì´ì§€ìš© (ì‹¬ì¸µ ë¶„ì„)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„± (## í—¤ë”, **, ë¦¬ìŠ¤íŠ¸, í…Œì´ë¸” ë“± ì ê·¹ í™œìš©)
- êµ¬ì¡°:
  1. `## ì£¼ìš” ì´ìŠˆ ë¶„ì„` â€” main_topicsì˜ ê° ì£¼ì œë¥¼ `### ì£¼ì œëª…` í˜•ì‹ì˜ ì†Œì œëª©ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ë¶„ì„
     - ê° ì´ìŠˆëŠ” **ë°°ê²½** Â· **ì˜í–¥** Â· **ì „ë§** 3ë‹¨ êµ¬ì¡°
  2. `## ğŸ’¡ íˆ¬ì ì¸ì‚¬ì´íŠ¸` â€” ì‹¤ì§ˆì  ì‹œì‚¬ì  2~3ê°€ì§€
  3. `## ğŸ“– ìš©ì–´ í•´ì„¤` â€” ì˜ìƒì— ë‚˜ì˜¨ ì „ë¬¸ ìš©ì–´ë¥¼ í…Œì´ë¸”ë¡œ ì„¤ëª…

- **í•µì‹¬**: `## ğŸ“° ì£¼ìš” ì´ìŠˆ ë¶„ì„` ì„¹ì…˜ì˜ ì´ìŠˆ ì œëª©ì´ main_topicsì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
  kakao_summaryì—ì„œ í•œ ì¤„ë¡œ ìš”ì•½í•œ ê²ƒì„ ì—¬ê¸°ì„œ ì‹¬ì¸µ ë¶„ì„í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.
- kakao_summaryë³´ë‹¤ 3~5ë°° í’ë¶€í•œ ì •ë³´ëŸ‰
- ìµœì†Œ 800ì ì´ìƒ ì‘ì„±
"""


def summarize(transcript, video_id):
    """
    Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë“€ì–¼ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤.

    Returns:
        dict | None: ìš”ì•½ JSON ë˜ëŠ” ì‹¤íŒ¨ ì‹œ None
    """
    cfg = Config.instance()
    model = cfg.get("ai.model", "gemini-2.5-flash")

    video_url = f"https://www.youtube.com/watch?v={video_id}"
    prompt = DUAL_SUMMARY_PROMPT.format(
        video_url=video_url,
        transcript=transcript
    )

    try:
        client = _get_client()
        response = client.models.generate_content(
            model=model,
            contents=prompt
        )
        text = response.text

        # JSON ì¶”ì¶œ
        json_match = re.search(r'\{[\s\S]*\}', text)
        if json_match:
            json_str = json_match.group()

            # ì œì–´ ë¬¸ì ì •ì œ (ì¤„ë°”ê¿ˆ/íƒ­ ë³´ì¡´, ê·¸ ì™¸ ì œê±°)
            json_str = re.sub(r'[\x00-\x08\x0b\x0c\x0e-\x1f\x7f]', '', json_str)

            try:
                result = json.loads(json_str, strict=False)
            except json.JSONDecodeError as e:
                log.warning(f"1ì°¨ JSON íŒŒì‹± ì‹¤íŒ¨: {e}")
                try:
                    import ast
                    result = ast.literal_eval(json_str)
                except Exception as e2:
                    log.error(f"JSON íŒŒì‹± ì‹¤íŒ¨: {e2}")
                    log.debug(f"ì›ë³¸ í…ìŠ¤íŠ¸ ì¼ë¶€: {text[:200]}...")
                    return None

            # í•„ìˆ˜ í•„ë“œ ì¡´ì¬ í™•ì¸
            if 'kakao_summary' not in result:
                log.warning("kakao_summary í•„ë“œ ëˆ„ë½")
                return None
            if 'web_report' not in result:
                log.warning("web_report í•„ë“œ ëˆ„ë½")
                return None

            log.info(f"ë“€ì–¼ ìš”ì•½ ì™„ë£Œ (ì¹´í†¡: {len(result['kakao_summary'])}ì, ì›¹: {len(result['web_report'])}ì)")
            return result

        log.error("JSON íŒŒì‹± ì‹¤íŒ¨: ì‘ë‹µì—ì„œ JSONì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None

    except Exception as e:
        log.error(f"Gemini ìš”ì•½ ì˜¤ë¥˜: {e}")
        return None
