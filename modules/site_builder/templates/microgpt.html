<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommitKim MicroGPT (Client-Side Training)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
                        surface: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1' },
                    },
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Pretendard:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .arch-block {
            transition: all 0.2s ease;
            border: 2px solid #e2e8f0;
            cursor: help;
            /* Indicate hoverable */
            position: relative;
        }

        .arch-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 10;
        }

        .arch-block.active {
            border-color: #6366f1;
            background-color: #eef2ff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        /* Highlight active word in dataset */
        .word-active {
            background-color: #e0e7ff;
            /* indigo-100 */
            color: #4338ca;
            /* indigo-700 */
            font-weight: bold;
            border-radius: 4px;
            padding: 0 4px;
            display: inline-block;
        }

        /* Tooltip styling using attribute */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            white-space: nowrap;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
            z-index: 50;
            pointer-events: none;
        }

        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1e293b;
            margin-bottom: -6px;
            /* Adjust overlap */
            z-index: 50;
        }

        /* Responsive Tooltip (Hidden on very small screens if annoying? No, keep it) */

        /* Correct Answer Animation */
        @keyframes correct-pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .correct-answer {
            animation: correct-pop 0.3s ease-out;
            background-color: #d1fae5 !important;
            /* emerald-100 */
            border-color: #34d399 !important;
            /* emerald-400 */
            color: #065f46 !important;
            /* emerald-800 */
            font-weight: bold;
        }

        /* Custom Scrollbar for panels */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-surface-50 min-h-screen text-slate-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <a href="../index.html" class="flex items-center gap-2">
                <span
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                    CommitKim
                </span>
                <span
                    class="text-xs font-bold px-2 py-1 bg-indigo-50 text-indigo-600 rounded-full hidden sm:inline-block">Interactive
                    Training</span>
            </a>

            <div class="flex items-center gap-4 text-sm text-slate-500">
                <span class="hidden md:inline">Browser-Local Storage Active âœ…</span>
                <a href="https://gist.github.com/karpathy/8627fe009c40f57531cb18360106ce95" target="_blank"
                    class="flex items-center gap-2 hover:text-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                    <span class="hidden sm:inline">Original by Andrej Karpathy</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">

        <!-- Controls Panel -->
        <div
            class="bg-white rounded-2xl sm:rounded-[2rem] shadow-sm border border-surface-200 p-5 sm:p-8 mb-8 sm:mb-10 z-40">
            <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6 sm:gap-8">
                <div class="flex-1 w-full">
                    <h2 class="text-xl sm:text-2xl font-bold text-slate-900 mb-2">ğŸ§  Live MicroGPT</h2>
                    <p class="text-slate-500 text-xs sm:text-sm mb-4">í•™ìŠµ ë°ì´í„°ë¥¼ ì„ íƒí•˜ê³  AIë¥¼ í›ˆë ¨ì‹œì¼œë³´ì„¸ìš”. ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ í•™ìŠµ ê¸°ë¡ì€ ì €ì¥ë©ë‹ˆë‹¤.
                    </p>

                    <!-- Data Selector -->
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <select id="dataSelector" onchange="changeDataset()"
                            class="w-full sm:w-auto px-4 py-2 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 focus:ring-2 focus:ring-indigo-200 outline-none font-medium">
                            <option value="fruits">ğŸ Fruits (ê³¼ì¼ ì´ë¦„)</option>
                            <option value="colors">ğŸ¨ Colors (ìƒ‰ê¹” ì´ë¦„)</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons: Optimized for Mobile -->
                <div class="flex flex-wrap gap-2 sm:gap-3 w-full sm:w-auto">
                    <button onclick="trainStep(1)" id="btnTrain1"
                        class="flex-1 sm:flex-none justify-center px-4 sm:px-5 py-3 bg-indigo-500 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2 active:scale-95 whitespace-nowrap text-sm sm:text-base">
                        <span>â–¶ï¸</span> 1 Step
                    </button>
                    <!-- 10000 Steps Button -->
                    <button onclick="trainStep(10000)" id="btnTrain10000"
                        class="flex-1 sm:flex-none justify-center px-4 sm:px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-500/30 flex items-center gap-2 active:scale-95 whitespace-nowrap text-sm sm:text-base">
                        <span>ğŸš€</span> 10k Steps
                    </button>
                    <button onclick="resetModel(true)"
                        class="flex-none px-4 sm:px-5 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all flex items-center gap-2 active:scale-95 text-sm sm:text-base">
                        <span>ğŸ”„</span>
                    </button>
                </div>
            </div>

            <!-- Training Stats -->
            <div
                class="mt-6 flex flex-col sm:flex-row flex-wrap xl:flex-nowrap gap-4 sm:gap-6 text-sm border-t border-slate-100 pt-4 items-start sm:items-center">
                <div class="flex items-center gap-6 w-full sm:w-auto">
                    <div class="min-w-[80px]">Step: <strong id="dispStep"
                            class="text-indigo-600 font-mono text-lg">0</strong></div>
                    <div class="min-w-[80px]">Loss: <strong id="dispLoss"
                            class="text-red-500 font-mono text-lg">-</strong></div>
                </div>

                <!-- Current Batch Info -->
                <div
                    class="w-full xl:w-auto flex-1 flex flex-col sm:flex-row justify-center items-center gap-3 sm:gap-4 bg-slate-50 rounded-lg px-4 py-3 border border-slate-200 mx-0 xl:mx-4">
                    <div class="text-center sm:text-left w-full sm:w-auto flex justify-between sm:block">
                        <span class="text-xs text-slate-400 font-bold uppercase block">Current Pair</span>
                        <span class="text-[10px] text-slate-400 sm:block hidden">(Sliding Window)</span>
                    </div>
                    <!-- Batch Visualization -->
                    <div class="flex items-center gap-2 font-mono text-base justify-center w-full sm:w-auto">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] text-slate-400 mb-1">Input</span>
                            <span
                                class="bg-white px-2 sm:px-3 py-1 rounded border border-slate-200 text-slate-600 shadow-sm text-sm sm:text-base"
                                id="batchInput">...</span>
                        </div>
                        <span class="text-slate-300 text-xl font-bold mt-4">â†’</span>
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] text-indigo-400 mb-1">Target</span>
                            <span
                                class="bg-indigo-100 px-2 sm:px-3 py-1 rounded border border-indigo-200 text-indigo-700 shadow-sm font-bold text-sm sm:text-base"
                                id="batchTarget">?</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout: Absolute Strategy for Desktop, Stacked for Mobile -->
        <div class="flex flex-col lg:flex-row gap-6 mb-12 relative items-start">

            <!-- Left: Training Data -->
            <!-- Mobile: h-[350px] fixed height to allow scroll, nice and compact -->
            <!-- Desktop: lg:h-auto lg:min-h-0 + absolute inset -->
            <div
                class="w-full lg:w-4/12 relative flex flex-col h-[350px] lg:h-auto lg:min-h-0 self-stretch order-2 lg:order-1">
                <!-- Order-2 on mobile?? Maybe users want to see Charts (Results) first? -->
                <!-- Actually, seeing input is good. check order. usually Input -> Output. Order 1 is fine. -->
                <!-- Let's keep Training Data first on mobile for education flow (Input -> Output) -->
                <div
                    class="lg:absolute lg:inset-0 flex flex-col h-full rounded-2xl glass-panel shadow-sm p-4 sm:p-6 overflow-hidden">
                    <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="text-xl">ğŸ“š</span> Training Dataset
                    </h3>
                    <p class="text-xs text-slate-500 mb-3 leading-relaxed">
                        <span class="text-indigo-600 font-bold">ë³´ë¼ìƒ‰ í•˜ì´ë¼ì´íŠ¸</span>ëŠ” í˜„ì¬ í•™ìŠµ ì¤‘ì¸ ë‹¨ì–´ì…ë‹ˆë‹¤.
                    </p>
                    <div id="datasetDisplay"
                        class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 p-4 rounded-xl border border-slate-100 font-mono text-sm text-slate-600 leading-relaxed whitespace-pre-wrap shadow-inner">
                        Loading...</div>
                </div>
            </div>

            <!-- Right: Results & Panels -->
            <div class="w-full lg:w-8/12 flex flex-col gap-6 order-1 lg:order-2">

                <!-- Loss Chart -->
                <div class="glass-panel rounded-2xl p-4 sm:p-6 shadow-sm shrink-0">
                    <h3 class="text-lg font-bold text-slate-800 mb-1">ğŸ“‰ Loss History</h3>
                    <p class="text-xs text-slate-500 mb-4">
                        * Loss(ì†ì‹¤): <strong class="text-indigo-600">AIì˜ ì˜¤ë‹µë¥ </strong> (0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì¢‹ìŒ)
                    </p>
                    <div class="h-[180px] sm:h-[200px]">
                        <canvas id="lossChart"></canvas>
                    </div>
                </div>

                <!-- Generated Samples -->
                <div class="glass-panel rounded-2xl p-4 sm:p-6 shadow-sm shrink-0 min-h-[300px]">
                    <h3 class="text-lg font-bold text-slate-800 mb-2 flex justify-between items-center">
                        <span>âœï¸ Generated Samples</span>
                        <button onclick="generateSamples()"
                            class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded hover:bg-indigo-200 transition-colors font-bold flex items-center gap-1">
                            <span>ğŸ²</span> <span class="hidden sm:inline">Generate Now</span><span
                                class="sm:hidden">Run</span>
                        </button>
                    </h3>
                    <div class="flex flex-col gap-1 mb-4 text-xs text-slate-500">
                        <p>ì²« ê¸€ìëŠ” <strong>ëœë¤</strong>, ê·¸ ë‹¤ìŒì€ <strong>AI ì˜ˆì¸¡</strong>ì…ë‹ˆë‹¤.</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-800 border border-green-200">
                                âœ… ì •ë‹µ
                            </span>
                            <span>: í•™ìŠµ ë°ì´í„°ì™€ ì¼ì¹˜</span>
                        </div>
                    </div>

                    <div id="samples-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                        <div class="text-slate-400 text-sm italic py-2 md:col-span-2 text-center">Ready to generate...
                        </div>
                    </div>
                </div>

                <!-- Persistence -->
                <div class="glass-panel rounded-2xl p-4 sm:p-6 shadow-sm flex flex-col">
                    <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <span>ğŸ’¾ Persistence</span>
                    </h3>
                    <p class="text-xs text-slate-500 mb-2">
                        ë¸Œë¼ìš°ì € <code>localStorage</code>ì— ëª¨ë¸ ìƒíƒœ(ê°€ì¤‘ì¹˜)ê°€ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
                    </p>
                    <div
                        class="font-mono text-xs bg-slate-800 text-slate-200 p-4 rounded-xl overflow-x-auto shadow-inner flex flex-col justify-center">
                        <div class="flex justify-between border-b border-slate-700 pb-2 mb-2">
                            <span class="text-indigo-400">Storage</span>
                            <span id="storage-size" class="text-emerald-400">...</span>
                        </div>
                        <div id="persistence-preview" class="whitespace-pre">Not saved yet...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom: Architecture (Vertical Layout) -->
        <div class="w-full mb-12">
            <div class="glass-panel rounded-2xl p-5 sm:p-8 shadow-sm">
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <span class="text-xl">ğŸ—ï¸</span> Model Architecture
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 items-start">
                    <!-- Vertical Diagram -->
                    <div class="flex flex-col items-center gap-4 max-w-sm mx-auto w-full">
                        <!-- Input -->
                        <div id="blk-input"
                            class="arch-block w-full text-center py-3 rounded-lg bg-slate-50 relative group"
                            data-tooltip="ì…ë ¥ ë‹¨ì–´">
                            <span class="font-bold text-slate-700">Input (Indices)</span>
                        </div>
                        <div class="w-0 h-6 border-l-2 border-slate-300 border-dashed"></div>

                        <!-- Embedding -->
                        <div id="blk-emb" class="arch-block w-full flex gap-2 p-1 bg-blue-50/50 rounded-lg group"
                            data-tooltip="ë‹¨ì–´ì™€ ìœ„ì¹˜ë¥¼ ë²¡í„°ë¡œ ë³€í™˜">
                            <div class="flex-1 text-center py-2 rounded bg-blue-50 text-xs text-blue-800 font-bold">
                                Token Emb</div>
                            <div class="flex-1 text-center py-2 rounded bg-blue-50 text-xs text-blue-800 font-bold">Pos
                                Emb</div>
                        </div>
                        <div class="w-0 h-6 border-l-2 border-slate-300 border-dashed"></div>

                        <!-- Transformer -->
                        <div id="blk-transformer"
                            class="arch-block w-full p-4 rounded-xl bg-indigo-50 border-indigo-100 flex flex-col gap-2 group"
                            data-tooltip="ê´€ê³„ íŒŒì•… ë° ì¶”ë¡ ">
                            <div class="text-[10px] text-center text-indigo-400 uppercase tracking-widest font-bold">
                                Transformer Block</div>
                            <div
                                class="w-full text-center py-2 rounded bg-white border border-orange-100 text-orange-700 text-xs font-bold shadow-sm">
                                Self-Attention</div>
                            <div
                                class="w-full text-center py-2 rounded bg-white border border-green-100 text-green-700 text-xs font-bold shadow-sm">
                                MLP (Feed Forward)</div>
                        </div>
                        <div class="w-0 h-6 border-l-2 border-slate-300 border-dashed"></div>

                        <!-- Head -->
                        <div id="blk-head"
                            class="arch-block w-full text-center py-3 rounded-lg bg-pink-50 text-pink-700 font-bold group"
                            data-tooltip="ì°¨ì› ë³€í™˜">
                            Linear Head
                        </div>
                        <div class="w-0 h-6 border-l-2 border-slate-300 border-dashed"></div>

                        <!-- Softmax -->
                        <div id="blk-softmax"
                            class="arch-block w-full text-center py-3 rounded-lg bg-slate-100 text-slate-600 font-bold group"
                            data-tooltip="í™•ë¥  ê³„ì‚°">
                            Softmax
                        </div>
                    </div>

                    <!-- Explanations (Vertical List matches diagram flow) -->
                    <div class="flex flex-col justify-between h-auto py-4 space-y-6">
                        <div class="pl-6 border-l-4 border-slate-200 space-y-8">
                            <div class="relative">
                                <div
                                    class="absolute -left-[31px] top-0 w-4 h-4 rounded-full bg-slate-400 ring-4 ring-white">
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">1. Input</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">
                                    ì‚¬ëŒì˜ ë‹¨ì–´ë¥¼ ì»´í“¨í„°ê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” <b>ìˆ«ì(Index)</b>ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div class="relative">
                                <div
                                    class="absolute -left-[31px] top-0 w-4 h-4 rounded-full bg-blue-400 ring-4 ring-white">
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">2. Embeddings</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">
                                    ìˆ«ìë¥¼ ê³ ì°¨ì›ì˜ <b>ë²¡í„°(Vector)</b>ë¡œ ë°”ê¿‰ë‹ˆë‹¤. ë‹¨ì–´ì˜ ì˜ë¯¸(Token)ì™€ ë¬¸ì¥ ë‚´ ìœ„ì¹˜(Pos) ì •ë³´ë¥¼ ëª¨ë‘ ë‹´ìŠµë‹ˆë‹¤.
                                </p>
                            </div>
                            <div class="relative">
                                <div
                                    class="absolute -left-[31px] top-0 w-4 h-4 rounded-full bg-indigo-400 ring-4 ring-white">
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">3. Transformer</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">
                                    <b>Self-Attention:</b> ë‹¨ì–´ë“¤ ì‚¬ì´ì˜ ê´€ê³„(ë¬¸ë§¥)ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.<br>
                                    <b>MLP:</b> íŒŒì•…í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë”ìš± ë³µì¡í•œ íŒ¨í„´ì„ ì²˜ë¦¬í•˜ê³  ê¸°ì–µí•©ë‹ˆë‹¤.
                                </p>
                            </div>
                            <div class="relative">
                                <div
                                    class="absolute -left-[31px] top-0 w-4 h-4 rounded-full bg-pink-400 ring-4 ring-white">
                                </div>
                                <h4 class="font-bold text-slate-800 mb-1">4. Linear Head & Softmax</h4>
                                <p class="text-xs text-slate-500 leading-relaxed">
                                    ì²˜ë¦¬ëœ ë°ì´í„°ë¥¼ ë‹¨ì–´ì¥ í¬ê¸°ë¡œ ë³€í™˜í•œ ë’¤, ë‹¤ìŒ ë‹¨ì–´ë¡œ ì˜¬ <b>í™•ë¥ (%)</b>ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
                                </p>
                            </div>
                        </div>

                        <div
                            class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-xs text-indigo-800 mt-4 leading-relaxed">
                            ğŸ’¡ <b>Tip:</b> ì´ êµ¬ì¡°ëŠ” ChatGPT(GPT-3, GPT-4)ì˜ ì¶•ì†ŒíŒì…ë‹ˆë‹¤. ê·œëª¨ëŠ” ì‘ì§€ë§Œ ì‘ë™ ì›ë¦¬ëŠ” ë™ì¼í•©ë‹ˆë‹¤!
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script>
        // --- 0. Data & Persistence ---
        const datasets = {
            fruits: "apple\nbanana\ncherry\ndate\nelderberry\nfig\ngrape\nhoneydew\nkiwi\nlemon\nmango\nnectarine\norange\npapaya\n",
            colors: "red\norange\nyellow\ngreen\nblue\npurple\npink\nblack\nwhite\ngray\nbrown\ncyan\nmagenta\n"
        };

        // Massive List Update
        datasets.fruits += "raspberry\nstrawberry\ntangerine\nugli\nwatermelon\nblueberries\ncantaloupe\ndragonfruit\nblackberries\ncranberries\ngrapefruit\nguava\nlime\nlychee\npassionfruit\npeach\npear\npineapple\nplum\npomegranate\napricot\navocado\nblackberry\nboysenberry\ncoconut\ncurrant\ndurian\ngooseberry\nkumquat\nmulberry\npersimmon\nquince\nstarfruit\n";
        datasets.colors += "lavender\nindigo\nturquoise\nmaroon\nnavy\nolive\nteal\nviolet\nbeige\ncharcoal\ncoral\ncrimson\ngold\nivory\nkhaki\nlime\nmint\nochre\npeach\nsalmon\nsepia\nsienna\nsilver\ntan\ntomato\nwheat\nazure\nbronze\nchocolate\ncopper\nemerald\nfuchsia\njade\nlilac\nmaurve\nperiwinkle\nruby\nsapphire\nscarlet\n";

        // --- 1. Autograd & Models ---
        class Value { constructor(t, e = [], s = "", i = "") { this.data = t, this.grad = 0, this._prev = new Set(e), this._op = s, this.label = i, this._backward = () => { } } add(t) { t = t instanceof Value ? t : new Value(t); const e = new Value(this.data + t.data, [this, t], "+"); return e._backward = () => { this.grad += 1 * e.grad, t.grad += 1 * e.grad }, e } mul(t) { t = t instanceof Value ? t : new Value(t); const e = new Value(this.data * t.data, [this, t], "*"); return e._backward = () => { this.grad += t.data * e.grad, t.grad += this.data * e.grad }, e } tanh() { const t = this.data, e = Math.tanh(t), s = new Value(e, [this], "tanh"); return s._backward = () => { this.grad += (1 - e * e) * s.grad }, s } exp() { const t = this.data, e = new Value(Math.exp(t), [this], "exp"); return e._backward = () => { this.grad += e.data * e.grad }, e } pow(t) { const e = this.data, s = new Value(Math.pow(e, t), [this], `**${t}`); return s._backward = () => { this.grad += t * Math.pow(e, t - 1) * s.grad }, s } log() { const t = new Value(Math.log(this.data), [this], "log"); return t._backward = () => { this.grad += 1 / this.data * t.grad }, t } backward() { const t = [], e = new Set, s = i => { if (!e.has(i)) { e.add(i); for (let t of i._prev) s(t); t.push(i) } }; s(this), this.grad = 1; for (let e = t.length - 1; e >= 0; e--)t[e]._backward() } }
        function gaussian(t = 0, e = 1) { const s = 1 - Math.random(), i = Math.random(); return Math.sqrt(-2 * Math.log(s)) * Math.cos(2 * Math.PI * i) * e + t }
        class Module { zeroGrad() { for (let t of this.parameters()) t.grad = 0 } parameters() { return [] } }
        class Neuron extends Module { constructor(t) { super(), this.w = Array(t).fill(0).map(() => new Value(gaussian(0, .1))), this.b = new Value(0) } call(t) { let e = this.b; for (let s = 0; s < this.w.length; s++)e = e.add(this.w[s].mul(t[s])); return e.tanh() } parameters() { return [...this.w, this.b] } }
        class Layer extends Module { constructor(t, e) { super(), this.neurons = Array(e).fill(0).map(() => new Neuron(t)) } call(t) { return this.neurons.map(e => e.call(t)) } parameters() { return this.neurons.flatMap(t => t.parameters()) } }
        class MLP extends Module { constructor(t, e) { super(), this.layers = []; const s = [t, ...e]; for (let t = 0; t < e.length; t++)this.layers.push(new Layer(s[t], s[t + 1])) } call(t) { for (let e of this.layers) t = e.call(t); return t } parameters() { return this.layers.flatMap(t => t.parameters()) } }
        class MicroModel extends Module { constructor(t, e, s) { super(), this.vocabSize = t, this.blockSize = s, this.C = Array(t).fill(0).map(() => Array(e).fill(0).map(() => new Value(gaussian(0, .1)))), this.mlp = new MLP(s * e, [32, t]) } call(t) { let e = []; for (let s = 0; s < t.length; s++)e.push(...this.C[t[s]]); return this.mlp.call(e) } parameters() { return [...this.C.flat(), ...this.mlp.parameters()] } }

        // --- 2. State Management ---
        let model, stoi, itos, vocabSize;
        let X = [], Y = [], SourceIndices = []; // To track where each sample came from
        let step = 0;
        let lossHistory = [];
        const blockSize = 3;
        let rawDataLines = [];
        let rawDataString = ""; // Needed for validation

        function init() {
            loadState();
        }

        function changeDataset() {
            resetModel(true); // Always reset when changing type
        }

        function getDataset() {
            const sel = document.getElementById('dataSelector').value;
            return datasets[sel] || datasets.fruits;
        }

        function buildDataset() {
            const rawData = getDataset();
            rawDataString = rawData; // Store globally for validation
            const container = document.getElementById('datasetDisplay');

            // Build HTML with highlightable spans
            rawDataLines = rawData.split('\n').filter(w => w.length > 0);
            container.innerHTML = rawDataLines.map((line, i) => `<span id="word-${i}" class="block py-0.5 px-1 rounded transition-colors">${line}</span>`).join('');

            const chars = Array.from(new Set(rawData.replace(/\n/g, '.'))).sort();
            stoi = {}; itos = {};
            chars.forEach((c, i) => { stoi[c] = i; itos[i] = c; });
            vocabSize = chars.length;

            X = []; Y = []; SourceIndices = [];
            for (let i = 0; i < rawDataLines.length; i++) {
                let w = rawDataLines[i];
                let ctx = Array(blockSize).fill(0);
                for (let ch of w + '.') {
                    const ix = stoi[ch === '\n' ? '.' : ch] || 0;
                    X.push([...ctx]);
                    Y.push(ix);
                    SourceIndices.push(i); // This X comes from word i
                    ctx.shift();
                    ctx.push(ix);
                }
            }
            return rawData;
        }

        function initModel(forceNew = false) {
            const rawData = buildDataset();

            // Try to load weights if exists and matches config
            const savedState = localStorage.getItem('microgpt_state');
            if (!forceNew && savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.dataset === document.getElementById('dataSelector').value) {
                        // Restore logic
                        model = new MicroModel(vocabSize, 8, blockSize);
                        if (state.params && state.params.length > 0) {
                            const params = model.parameters();
                            if (params.length === state.params.length) {
                                for (let i = 0; i < params.length; i++) {
                                    params[i].data = state.params[i];
                                }
                                step = state.step;
                                lossHistory = state.lossHistory;
                                updateStats(lossHistory[lossHistory.length - 1] || 0);
                                updateChart();
                                updateStoragePreview();
                                if (step > 0) lockSelector();
                                console.log("State restored.");
                                return;
                            }
                        }
                    }
                } catch (e) { console.warn("Failed to load state", e); }
            }

            // New Init
            model = new MicroModel(vocabSize, 8, blockSize);
            step = 0;
            lossHistory = [];
            updateChart();
            updateStats(0);
            updateStoragePreview();
            document.getElementById('dispLoss').innerText = '-';
            unlockSelector();
        }

        function saveState() {
            const params = model.parameters().map(p => p.data);
            const state = {
                dataset: document.getElementById('dataSelector').value,
                step: step,
                lossHistory: lossHistory,
                params: params
            };
            try {
                const s = JSON.stringify(state);
                localStorage.setItem('microgpt_state', s);
                updateStoragePreview(s.length);
            } catch (e) {
                console.error("Storage limit reached");
            }
        }

        function updateStoragePreview(size) {
            const preview = document.getElementById('persistence-preview');
            const sizeLabel = document.getElementById('storage-size');

            if (!size) {
                const s = localStorage.getItem('microgpt_state');
                size = s ? s.length : 0;
            }

            sizeLabel.innerText = `${(size / 1024).toFixed(2)} KB used`;

            if (step === 0) {
                preview.innerText = "// Initialized (No weights saved)";
                return;
            }

            // Fake a JSON preview of the model state
            preview.innerHTML = `<span class="text-blue-400">"step"</span>: <span class="text-green-400">${step}</span>,
<span class="text-blue-400">"dataset"</span>: <span class="text-orange-400">"${document.getElementById('dataSelector').value}"</span>,
<span class="text-blue-400">"loss"</span>: <span class="text-green-400">[${lossHistory.slice(-3).map(n => n.toFixed(3)).join(', ')}...]</span>,
<span class="text-blue-400">"params"</span>: [
  <span class="text-slate-500">// ${model.parameters().length} float values (weights)</span>
  ${model.parameters().slice(0, 3).map(p => p.data.toFixed(4)).join(', ')}, ...
]`;
        }

        function loadState() {
            // Already handled in initModel logic mostly, just ensuring UI sync
            const savedState = localStorage.getItem('microgpt_state');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    document.getElementById('dataSelector').value = state.dataset || 'fruits';
                } catch (e) { }
            }
            initModel(false);
        }

        function resetModel(force = true) {
            localStorage.removeItem('microgpt_state');
            initModel(true);
        }

        function lockSelector() {
            document.getElementById('dataSelector').disabled = true;
        }

        function unlockSelector() {
            document.getElementById('dataSelector').disabled = false;
        }

        // --- 3. Training Loop ---
        async function trainStep(count) {
            lockSelector();

            const btn1 = document.getElementById('btnTrain1');
            const btn10000 = document.getElementById('btnTrain10000');
            const originalText = btn10000 ? btn10000.innerText : "ğŸš€ 10,000 Steps";

            if (btn1) btn1.disabled = true;
            if (btn10000) btn10000.disabled = true;

            // Update visually less often for high step counts to keep performance
            const visualFreq = count >= 100 ? 50 : 1;

            for (let i = 0; i < count; i++) {
                // Progress Indicator for long runs
                if (count >= 1000 && i % 100 === 0 && btn10000) {
                    const pct = Math.round((i / count) * 100);
                    btn10000.innerHTML = `<span>â³</span> ${pct}%`;
                    await new Promise(r => setTimeout(r, 0)); // Force UI refresh
                }

                const ri = Math.floor(Math.random() * X.length);
                const x = X[ri];
                const y = Y[ri];
                const sourceIdx = SourceIndices[ri];

                // Update visuals
                if (i % visualFreq === 0 || i === count - 1) {
                    const inputChars = x.map(ix => itos[ix]).join('').replace(/\./g, 'Â·');
                    const targetChar = itos[y].replace(/\./g, 'END');

                    document.getElementById('batchInput').innerText = `"${inputChars}"`;
                    document.getElementById('batchTarget').innerText = `"${targetChar}"`;

                    document.querySelectorAll('.word-active').forEach(el => el.classList.remove('word-active'));
                    const el = document.getElementById(`word-${sourceIdx}`);
                    const container = document.getElementById('datasetDisplay');

                    if (el && container) {
                        el.classList.add('word-active');
                        // Manual scroll to avoid page jumping - use scrollTop within container
                        const top = el.offsetTop - container.offsetTop;
                        const centerOffset = (container.clientHeight - el.clientHeight) / 2;
                        container.scrollTo({ top: top - centerOffset, behavior: 'smooth' });
                    }
                }

                // Forward & Backward
                const logits = model.call(x);
                const counts = logits.map(v => v.exp());
                const sum = counts.reduce((a, b) => a.add(b), new Value(0));
                const prob = counts[y].mul(sum.pow(-1));
                const loss = prob.log().mul(new Value(-1));

                model.zeroGrad();
                loss.backward();

                const lr = 0.1;
                for (let p of model.parameters()) p.data -= lr * p.grad;

                step++;
                lossHistory.push(loss.data);

                if (i % visualFreq === 0) {
                    updateStats(loss.data);
                    updateChart();
                    await new Promise(r => setTimeout(r, 0)); // Yield UI
                }
            }

            saveState();

            // Final Update
            updateStats(lossHistory[lossHistory.length - 1]);
            updateChart();
            // ALWAYS generate samples after training step
            generateSamples();

            // Reset UI
            if (btn1) btn1.disabled = false;
            if (btn10000) {
                btn10000.innerHTML = `<span>ğŸš€</span> 10k Steps`; // Text resets here
                btn10000.disabled = false;
            }
        }

        function updateStats(loss) {
            document.getElementById('dispStep').innerText = step;
            document.getElementById('dispLoss').innerText = typeof loss === 'number' ? loss.toFixed(4) : '-';
        }

        function generateSamples() {
            let out = [];
            for (let k = 0; k < 6; k++) {
                let ctx = Array(blockSize).fill(0); // '.' context
                let res = "";

                for (let t = 0; t < 12; t++) {
                    const logits = model.call(ctx);

                    // Weighted random choice
                    const counts = logits.map(v => Math.exp(v.data));
                    const sum = counts.reduce((a, b) => a + b, 0);
                    let r = Math.random() * sum;
                    let nextIx = 0;
                    for (let i = 0; i < counts.length; i++) {
                        r -= counts[i];
                        if (r <= 0) { nextIx = i; break; }
                    }

                    if (nextIx === 0) break; // EOS
                    const char = itos[nextIx];
                    res += char;
                    ctx.shift();
                    ctx.push(nextIx);
                }
                if (res.length > 0) out.push(res);
            }

            const container = document.getElementById('samples-container');
            container.innerHTML = out.map(s => {
                // Check correctness
                const isCorrect = rawDataLines.includes(s);
                const styleClass = isCorrect
                    ? "bg-emerald-100 border-emerald-400 text-emerald-800 correct-answer shadow-sm"
                    : "bg-indigo-50 border-indigo-100 text-indigo-800";

                const icon = isCorrect ? "âœ… " : "";

                return `<div class="${styleClass} px-3 py-2 rounded-lg font-mono text-sm border flex items-center justify-between group transition-all duration-300">
                    <span>${icon}${s}</span>
                </div>`;
            }).join('');
        }

        // --- Chart ---
        let chartCtx = document.getElementById('lossChart').getContext('2d');
        let chart = new Chart(chartCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Loss', data: [], borderColor: '#6366f1', borderWidth: 2, pointRadius: 0 }] },
            options: { animation: false, scales: { x: { display: false } } }
        });

        function updateChart() {
            const maxPoints = 100;
            let data = lossHistory;
            let labels = lossHistory.map((_, i) => i);

            if (lossHistory.length > maxPoints) {
                const ratio = Math.ceil(lossHistory.length / maxPoints);
                data = lossHistory.filter((_, i) => i % ratio === 0);
                labels = labels.filter((_, i) => i % ratio === 0);
            }

            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        window.onload = init;

    </script>
</body>

</html>