<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommitKim MicroGPT (Client-Side Training)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81' },
                        surface: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1' },
                    },
                    fontFamily: {
                        sans: ['Pretendard', '-apple-system', 'BlinkMacSystemFont', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Pretendard:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .arch-block {
            transition: all 0.2s ease;
            border: 2px solid #e2e8f0;
        }

        .arch-block.active {
            border-color: #6366f1;
            background-color: #eef2ff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>

<body class="bg-surface-50 min-h-screen text-slate-800">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <a href="../index.html" class="flex items-center gap-2">
                <span
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                    CommitKim
                </span>
                <span class="text-xs font-bold px-2 py-1 bg-indigo-50 text-indigo-600 rounded-full">Interactive
                    Training</span>
            </a>

            <div class="flex items-center gap-4 text-sm text-slate-500">
                <span class="hidden md:inline">Browser-Local Storage Active âœ…</span>
                <a href="https://github.com/karpathy/microgpt" target="_blank"
                    class="flex items-center gap-2 hover:text-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                    Original by Andrej Karpathy
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

        <!-- Controls -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-surface-200 p-8 mb-10 sticky top-20 z-40">
            <div class="flex flex-col xl:flex-row justify-between items-center gap-8">
                <div class="flex-1 w-full">
                    <h2 class="text-2xl font-bold text-slate-900 mb-2">ğŸ§  Live MicroGPT</h2>
                    <p class="text-slate-500 text-sm mb-4">í•™ìŠµ ë°ì´í„°ë¥¼ ì„ íƒí•˜ê³  AIë¥¼ í›ˆë ¨ì‹œì¼œë³´ì„¸ìš”. ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ í•™ìŠµ ê¸°ë¡ì€ ì €ì¥ë©ë‹ˆë‹¤.</p>

                    <!-- Data Selector -->
                    <div class="flex flex-col sm:flex-row gap-3">
                        <select id="dataSelector" onchange="changeDataset()"
                            class="px-4 py-2 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 focus:ring-2 focus:ring-indigo-200 outline-none font-medium">
                            <option value="fruits">ğŸ Fruits (ì‚¬ê³¼, ë°”ë‚˜ë‚˜...)</option>
                            <option value="colors">ğŸ¨ Colors (ë¹¨ê°•, íŒŒë‘...)</option>
                            <option value="custom">âœï¸ Custom (ì§ì ‘ ì…ë ¥)</option>
                        </select>
                        <textarea id="customInput"
                            class="hidden flex-1 px-4 py-2 rounded-xl border border-slate-200 text-sm font-mono h-[42px] min-h-[42px] resize-none focus:h-[100px] transition-all"
                            placeholder="Enter words separated by newline..."></textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="trainStep(1)" id="btnTrain1"
                        class="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-500/30 flex items-center gap-2 active:scale-95 whitespace-nowrap">
                        <span>â–¶ï¸</span> 1 Step
                    </button>
                    <button onclick="trainStep(10)" id="btnTrain10"
                        class="px-5 py-3 bg-indigo-500 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2 active:scale-95 whitespace-nowrap">
                        <span>â©</span> 10 Steps
                    </button>
                    <button onclick="resetModel(true)"
                        class="px-5 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-all flex items-center gap-2 active:scale-95">
                        <span>ğŸ”„</span> Reset
                    </button>
                </div>
            </div>

            <!-- Training Stats -->
            <div class="mt-6 flex flex-wrap xl:flex-nowrap gap-6 text-sm border-t border-slate-100 pt-4 items-center">
                <div class="min-w-[80px]">Step: <strong id="dispStep"
                        class="text-indigo-600 font-mono text-lg">0</strong></div>
                <div class="min-w-[80px]">Loss: <strong id="dispLoss" class="text-red-500 font-mono text-lg">-</strong>
                </div>

                <!-- Current Batch Info -->
                <div
                    class="w-full xl:w-auto flex-1 flex flex-col sm:flex-row justify-center items-center gap-4 bg-slate-50 rounded-lg px-4 py-3 border border-slate-200 mx-0 xl:mx-4">
                    <div class="text-center sm:text-left">
                        <span class="text-xs text-slate-400 font-bold uppercase block">Current Pair</span>
                        <span class="text-[10px] text-slate-400">(Sliding Window)</span>
                    </div>
                    <div class="flex items-center gap-2 font-mono text-base">
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] text-slate-400 mb-1">Input (Context)</span>
                            <span class="bg-white px-3 py-1 rounded border border-slate-200 text-slate-600 shadow-sm"
                                id="batchInput">...</span>
                        </div>
                        <span class="text-slate-300 text-xl font-bold mt-4">â†’</span>
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] text-indigo-400 mb-1">Target (Next)</span>
                            <span
                                class="bg-indigo-100 px-3 py-1 rounded border border-indigo-200 text-indigo-700 shadow-sm font-bold"
                                id="batchTarget">?</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">

            <!-- Left: Architecture & Data -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Training Data Viewer -->
                <div class="glass-panel rounded-2xl p-6 shadow-sm max-h-[400px] flex flex-col">
                    <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-2">
                        <span class="text-xl">ğŸ“š</span> Training Dataset
                    </h3>
                    <p class="text-xs text-slate-500 mb-3 leading-relaxed">
                        ì´ ë‹¨ì–´ë“¤ì„ í•œ ê¸€ìì”© ë°€ì–´ê°€ë©°(Sliding Window) í•™ìŠµí•©ë‹ˆë‹¤.<br>
                        ì˜ˆ: apple â†’ <span class="bg-slate-100 px-1 rounded">app</span>->l, <span
                            class="bg-slate-100 px-1 rounded">ppl</span>->e
                    </p>
                    <div id="datasetDisplay"
                        class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50 p-3 rounded-xl border border-slate-100 font-mono text-sm text-slate-600 leading-relaxed whitespace-pre-wrap">
                        Loading...</div>
                </div>

                <!-- Architecture Diagram -->
                <div class="glass-panel rounded-2xl p-6 shadow-sm">
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span class="text-xl">ğŸ—ï¸</span> Model Architecture
                    </h3>

                    <div class="relative flex flex-col items-center gap-3 text-sm font-medium text-slate-600"
                        id="arch-container">
                        <div id="blk-input" class="arch-block w-full text-center py-3 rounded-lg bg-slate-50">Input
                            (Indices)</div>
                        <div class="h-4 border-l-2 border-slate-200 border-dashed"></div>
                        <div id="blk-emb" class="arch-block w-full flex gap-2">
                            <div class="flex-1 text-center py-3 rounded-lg bg-blue-50">Token Emb</div>
                            <div class="flex-1 text-center py-3 rounded-lg bg-blue-50">Pos Emb</div>
                        </div>
                        <div class="h-4 border-l-2 border-slate-200 border-dashed"></div>
                        <div id="blk-transformer"
                            class="arch-block w-full p-4 rounded-xl bg-indigo-50 border-indigo-100 flex flex-col gap-2">
                            <div class="text-xs text-center text-indigo-400 uppercase tracking-widest mb-1">Transformer
                            </div>
                            <div class="w-full text-center py-2 rounded bg-orange-100 text-orange-700">Self-Attention
                            </div>
                            <div class="w-full text-center py-2 rounded bg-green-100 text-green-700">MLP</div>
                        </div>
                        <div class="h-4 border-l-2 border-slate-200 border-dashed"></div>
                        <div id="blk-head"
                            class="arch-block w-full text-center py-3 rounded-lg bg-pink-50 text-pink-700">Linear Head
                        </div>
                        <div class="h-4 border-l-2 border-slate-200 border-dashed"></div>
                        <div id="blk-softmax" class="arch-block w-full text-center py-3 rounded-lg bg-slate-100">Softmax
                            & Loss</div>
                    </div>
                </div>
            </div>

            <!-- Right: Results & Log -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Loss Chart -->
                <div class="glass-panel rounded-2xl p-6 shadow-sm">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“‰ Loss History</h3>
                    <div class="h-[200px]">
                        <canvas id="lossChart"></canvas>
                    </div>
                </div>

                <!-- Generated Samples -->
                <div class="glass-panel rounded-2xl p-6 shadow-sm min-h-[250px]">
                    <h3 class="text-lg font-bold text-slate-800 mb-2 flex justify-between items-center">
                        <span>âœï¸ Generated Samples</span>
                        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">Auto-generated</span>
                    </h3>
                    <p class="text-xs text-slate-500 mb-4">í•™ìŠµëœ AIê°€ 'ë°°ìš´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ' ìƒˆë¡œ ë§Œë“¤ì–´ë‚¸ ë‹¨ì–´ë“¤ì…ë‹ˆë‹¤. ì²˜ìŒì—” ì—‰ë§ì´ì§€ë§Œ ê°ˆìˆ˜ë¡ ë¹„ìŠ·í•´ì§‘ë‹ˆë‹¤.
                    </p>
                    <div id="samples-container" class="space-y-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-slate-400 text-sm italic py-2 md:col-span-2">Ready to generate...</div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script>
        // --- 0. Data & Persistence ---
        const datasets = {
            fruits: "apple\nbanana\ncherry\ndate\nelderberry\nfig\ngrape\nhoneydew\nkiwi\nlemon\nmango\nnectarine\norange\npapaya\n",
            colors: "red\norange\nyellow\ngreen\nblue\npurple\npink\nblack\nwhite\ngray\nbrown\ncyan\nmagenta\n"
        };

        // --- 1. Autograd & Models (Minified for brevity but fully functional) ---
        class Value { constructor(t, e = [], s = "", i = "") { this.data = t, this.grad = 0, this._prev = new Set(e), this._op = s, this.label = i, this._backward = () => { } } add(t) { t = t instanceof Value ? t : new Value(t); const e = new Value(this.data + t.data, [this, t], "+"); return e._backward = () => { this.grad += 1 * e.grad, t.grad += 1 * e.grad }, e } mul(t) { t = t instanceof Value ? t : new Value(t); const e = new Value(this.data * t.data, [this, t], "*"); return e._backward = () => { this.grad += t.data * e.grad, t.grad += this.data * e.grad }, e } tanh() { const t = this.data, e = Math.tanh(t), s = new Value(e, [this], "tanh"); return s._backward = () => { this.grad += (1 - e * e) * s.grad }, s } exp() { const t = this.data, e = new Value(Math.exp(t), [this], "exp"); return e._backward = () => { this.grad += e.data * e.grad }, e } pow(t) { const e = this.data, s = new Value(Math.pow(e, t), [this], `**${t}`); return s._backward = () => { this.grad += t * Math.pow(e, t - 1) * s.grad }, s } log() { const t = new Value(Math.log(this.data), [this], "log"); return t._backward = () => { this.grad += 1 / this.data * t.grad }, t } backward() { const t = [], e = new Set, s = i => { if (!e.has(i)) { e.add(i); for (let t of i._prev) s(t); t.push(i) } }; s(this), this.grad = 1; for (let e = t.length - 1; e >= 0; e--)t[e]._backward() } }
        function gaussian(t = 0, e = 1) { const s = 1 - Math.random(), i = Math.random(); return Math.sqrt(-2 * Math.log(s)) * Math.cos(2 * Math.PI * i) * e + t }
        class Module { zeroGrad() { for (let t of this.parameters()) t.grad = 0 } parameters() { return [] } }
        class Neuron extends Module { constructor(t) { super(), this.w = Array(t).fill(0).map(() => new Value(gaussian(0, .1))), this.b = new Value(0) } call(t) { let e = this.b; for (let s = 0; s < this.w.length; s++)e = e.add(this.w[s].mul(t[s])); return e.tanh() } parameters() { return [...this.w, this.b] } }
        class Layer extends Module { constructor(t, e) { super(), this.neurons = Array(e).fill(0).map(() => new Neuron(t)) } call(t) { return this.neurons.map(e => e.call(t)) } parameters() { return this.neurons.flatMap(t => t.parameters()) } }
        class MLP extends Module { constructor(t, e) { super(), this.layers = []; const s = [t, ...e]; for (let t = 0; t < e.length; t++)this.layers.push(new Layer(s[t], s[t + 1])) } call(t) { for (let e of this.layers) t = e.call(t); return t } parameters() { return this.layers.flatMap(t => t.parameters()) } }
        class MicroModel extends Module { constructor(t, e, s) { super(), this.vocabSize = t, this.blockSize = s, this.C = Array(t).fill(0).map(() => Array(e).fill(0).map(() => new Value(gaussian(0, .1)))), this.mlp = new MLP(s * e, [32, t]) } call(t) { let e = []; for (let s = 0; s < t.length; s++)e.push(...this.C[t[s]]); return this.mlp.call(e) } parameters() { return [...this.C.flat(), ...this.mlp.parameters()] } }

        // --- 2. State Management ---
        let model, stoi, itos, vocabSize;
        let X = [], Y = [];
        let step = 0;
        let lossHistory = [];
        const blockSize = 3;

        function init() {
            loadState();
        }

        function changeDataset() {
            const sel = document.getElementById('dataSelector').value;
            const inputArea = document.getElementById('customInput');

            if (sel === 'custom') {
                inputArea.classList.remove('hidden');
                // Give user a chance to type; we wait for them to finish or click train
            } else {
                inputArea.classList.add('hidden');
                resetModel(true); // Hard reset if switching predefined types
            }
        }

        function getDataset() {
            const sel = document.getElementById('dataSelector').value;
            if (sel === 'custom') {
                const val = document.getElementById('customInput').value.trim();
                return val.length > 0 ? val : "hello\nworld\ncommit\nkim\n";
            }
            return datasets[sel];
        }

        function buildDataset() {
            const rawData = getDataset();
            document.getElementById('datasetDisplay').innerText = rawData;

            const chars = Array.from(new Set(rawData.replace(/\n/g, '.'))).sort();
            stoi = {}; itos = {};
            chars.forEach((c, i) => { stoi[c] = i; itos[i] = c; });
            vocabSize = chars.length;

            X = []; Y = [];
            const words = rawData.split('\n').filter(w => w.length > 0);
            for (let w of words) {
                let ctx = Array(blockSize).fill(0); // Assuming 0 is '.' or first char
                for (let ch of w + '.') {
                    const ix = stoi[ch === '\n' ? '.' : ch] || 0;
                    X.push([...ctx]);
                    Y.push(ix);
                    ctx.shift();
                    ctx.push(ix);
                }
            }
            return rawData;
        }

        function initModel(forceNew = false) {
            const rawData = buildDataset();

            // Try to load weights if exists and matches config
            const savedState = localStorage.getItem('microgpt_state');
            if (!forceNew && savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.dataset === document.getElementById('dataSelector').value) {
                        // Restore logic
                        model = new MicroModel(vocabSize, 8, blockSize);
                        // Restore weights (simplified: we just restore step/loss for demo, 
                        // implementing full weight serialization for random JS objects is heavy)
                        // For this lightweight demo, let's just restore the step count and loss history,
                        // BUT we must re-train or random init. 
                        // To be truly persistent, we should save parameters.
                        // Let's implement parameter saving/loading.
                        if (state.params && state.params.length > 0) {
                            const params = model.parameters();
                            if (params.length === state.params.length) {
                                for (let i = 0; i < params.length; i++) {
                                    params[i].data = state.params[i];
                                }
                                step = state.step;
                                lossHistory = state.lossHistory;
                                updateStats(lossHistory[lossHistory.length - 1] || 0);
                                updateChart();
                                if (step > 0) lockSelector();
                                console.log("State restored.");
                                return;
                            }
                        }
                    }
                } catch (e) { console.warn("Failed to load state", e); }
            }

            // New Init
            model = new MicroModel(vocabSize, 8, blockSize);
            step = 0;
            lossHistory = [];
            updateChart();
            updateStats(0);
            document.getElementById('dispLoss').innerText = '-';
            unlockSelector();
        }

        function saveState() {
            const params = model.parameters().map(p => p.data);
            const state = {
                dataset: document.getElementById('dataSelector').value,
                // input: document.getElementById('customInput').value, // save custom text too if needed
                step: step,
                lossHistory: lossHistory,
                params: params
            };
            localStorage.setItem('microgpt_state', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('microgpt_state');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    document.getElementById('dataSelector').value = state.dataset || 'fruits';
                    if (state.dataset === 'custom') {
                        document.getElementById('customInput').value = "user defined..."; // partial restore limitation
                        document.getElementById('customInput').classList.remove('hidden');
                    }
                } catch (e) { }
            }
            changeDataset(); // Visual update
            initModel(false); // Load Logic
        }

        function resetModel(force = true) {
            localStorage.removeItem('microgpt_state');
            initModel(true);
        }

        function lockSelector() {
            document.getElementById('dataSelector').disabled = true;
            document.getElementById('customInput').disabled = true;
        }

        function unlockSelector() {
            document.getElementById('dataSelector').disabled = false;
            document.getElementById('customInput').disabled = false;
        }

        // --- 3. Training Loop ---
        async function trainStep(count) {
            lockSelector();

            const btn1 = document.getElementById('btnTrain1');
            const btn10 = document.getElementById('btnTrain10');
            btn1.disabled = true; btn10.disabled = true;

            for (let i = 0; i < count; i++) {
                const ri = Math.floor(Math.random() * X.length);
                const x = X[ri];
                const y = Y[ri];

                // Update UI
                const inputChars = x.map(ix => itos[ix]).join('').replace(/\./g, 'Â·');
                const targetChar = itos[y].replace(/\./g, 'END');

                if (i === count - 1 || count === 1) {
                    document.getElementById('batchInput').innerText = `"${inputChars}"`;
                    document.getElementById('batchTarget').innerText = `"${targetChar}"`;
                }

                // Forward & Backward
                const logits = model.call(x);
                const counts = logits.map(v => v.exp());
                const sum = counts.reduce((a, b) => a.add(b), new Value(0));
                const prob = counts[y].mul(sum.pow(-1));
                const loss = prob.log().mul(new Value(-1));

                model.zeroGrad();
                loss.backward();

                const lr = 0.1;
                for (let p of model.parameters()) p.data -= lr * p.grad;

                step++;
                lossHistory.push(loss.data);

                if (i === count - 1) {
                    updateStats(loss.data);
                    updateChart();
                }
            }

            saveState(); // Auto-save

            if (step % 10 === 0 || count >= 10 || step < 20) {
                generateSamples();
            }

            btn1.disabled = false; btn10.disabled = false;
        }

        function updateStats(loss) {
            document.getElementById('dispStep').innerText = step;
            document.getElementById('dispLoss').innerText = typeof loss === 'number' ? loss.toFixed(4) : '-';
        }

        function generateSamples() {
            let out = [];
            for (let k = 0; k < 4; k++) {
                let ctx = Array(blockSize).fill(0);
                let res = "";
                for (let t = 0; t < 12; t++) {
                    const logits = model.call(ctx);
                    let maxLogit = -99999;
                    let maxIx = 0;
                    logits.forEach((v, i) => { if (v.data > maxLogit) { maxLogit = v.data; maxIx = i; } });

                    if (maxIx === 0) break;
                    const char = itos[maxIx];
                    res += char;
                    ctx.shift();
                    ctx.push(maxIx);
                }
                out.push(res);
            }

            const container = document.getElementById('samples-container');
            container.innerHTML = out.map(s =>
                `<div class="bg-indigo-50 text-indigo-800 p-3 rounded-lg font-mono text-sm border border-indigo-100 flex items-center justify-between group">
                    <span>${s}</span>
                </div>`
            ).join('');
        }

        // --- Chart ---
        let chartCtx = document.getElementById('lossChart').getContext('2d');
        let chart = new Chart(chartCtx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Loss', data: [], borderColor: '#6366f1', borderWidth: 2, pointRadius: 0 }] },
            options: { animation: false, scales: { x: { display: false } } }
        });

        function updateChart() {
            // Decimate for performance if too long
            const maxPoints = 100;
            let data = lossHistory;
            let labels = lossHistory.map((_, i) => i);

            if (lossHistory.length > maxPoints) {
                const ratio = Math.ceil(lossHistory.length / maxPoints);
                data = lossHistory.filter((_, i) => i % ratio === 0);
                labels = labels.filter((_, i) => i % ratio === 0);
            }

            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        window.onload = init;

    </script>
</body>

</html>